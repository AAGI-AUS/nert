---
title: "Use nert to augment agricultural analytics with SMIPS data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Use nert to augment agricultural analytics with SMIPS data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r knitrsetup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

The TERN Soil Moisture Integration and Prediction System (SMIPS) generates
useful measurements of soil moisture at 1km resolution across all of Australia.
TERN provides this soil moisture information as packaged daily datasets [via
their TERN Data Portal](https://data.tern.org.au/model-derived/smips/), in
cloud-optimised GeoTIFF format. The **nert** package provides ease of access
to these SMIPS datasets for use and inclusion in R data analytics workflows.

This document introduces you to the **nert** package, including setup and
how to use the package to download SMIPS data for given locational coordinates
in Australia. The document then showcases an example of a grain production
experiment, and how we can use **nert** and the SMIPS soil moisture readings
to improve our analytics and modelling.

## Setup: Acquire and specify your TERN API key

An API key is required to access TERN datasets (including SMIPS) through 
their online data portal. The **nert** package streamlines the data process,
but still requires authorisation using an API key. However, it is
straightforward to sign up to the TERN Data Portal and acquire an API key that
you can use, and by setting it in your R environment (via `.Renviron`) you
can provide the **nert** package with that credential to allow convenient
access.

The following steps detail the process for signing in to your TERN account,
generating an API key, and storing it in your R environment:

1. Navigate to the TERN Data Discovery Portal (https://portal.tern.org.au/) in 
 a web browser, and click the "Sign in" button that appears in the top-right
 of the browser window.
 
    ![](nert_for_agricultural_analytics_tern_apikey_1.jpg){width=80%}
    
1. Click the Australian Access Federation button to sign in to the TERN Data
    Portal via your University ID (or alternatively, sign in via CILogon or
    your Google identity).
 
    ![](nert_for_agricultural_analytics_tern_apikey_2.jpg){width=80%}
    
1. Once signed in, click on the menu in the top-right with your name and click
    the "TERN Account" entry to open your account profile.
 
    ![](nert_for_agricultural_analytics_tern_apikey_4.jpg){width=80%}
    
1. On your account profile screen, navigate to the menu on the left-hand side,
    and click the "Create API key" entry.
 
    ![](nert_for_agricultural_analytics_tern_apikey_5.jpg){width=80%}
    
1. On this screen you can create your API key for accessing the TERN Data
    Portal. Give your key whatever name you like (e.g., below I have called
    the key "my_API_key" for demonstration purposes), and then click the
    "Request API Key" button.
 
    ![](nert_for_agricultural_analytics_tern_apikey_6.jpg){width=80%}
    
1. Your API key is now generated and appears as the string of text inside the
    text box on the page, together with the key's creation and expiration
    dates. Copy the API key to your clipboard, so that we can paste it into
    the `.Renvion` file in the next step.
 
    ![](nert_for_agricultural_analytics_tern_apikey_7.jpg){width=80%}
    
1. Open your `.Renviron` file (e.g., if you are using RStudio, an easy way to
    open the right file is to enter `usethis::edit_r_environ()`). Add a new
    line to the file to store your API key in the variable `TERN_API_KEY`:
    
    ```
    TERN_API_KEY='<paste your key here>'
    ```
 
    ![](nert_for_agricultural_analytics_tern_apikey_8.jpg){width=80%}
    
1. Save your `.Renviron` file, and restart your R session so that the change is 
    applied. You can then test that the **nert** package is reading your API 
    key properly by entering `nert::get_key()` at the R command console. If the
    API key was successfully read by **nert**, then you should see your API key
    appear verbatim as output.
 
    ![](nert_for_agricultural_analytics_tern_apikey_9.jpg){width=80%}

1. Finally, you can quickly test that the data download from the TERN portal 
    is working as intended by downloading a test data raster. The below code
    downloads the SMIPS "totalbucket" soil moisture data raster for January 1st
    2024, and uses the **terra** package's `extract` function to get a point 
    value for the soil moisture measurement at the Adelaide CBD (at 
    approximately -34.9285 decimal degrees latitude, 138.6007 longitude):
    
    ```{r testnertcache, include = FALSE}
    library(nert)
    adelaide <- readRDS("cache_adelaide.rds")
    ```
    
    ```{r testnert, eval = FALSE}
    library(nert)
    r <- read_smips(day = "2024-01-01")
    terra::extract(r, xy = TRUE, data.frame(lon = 138.6007, lat = -34.9285))
    ```
    ```{r testnertresults, echo = FALSE}
    adelaide
    ```

At this stage your **nert** package is now working, and you can use it to
easily download SMIPS datasets from the TERN Data Portal. The rest of this
vignette shows how you can use this downloaded soil moisture data to augment
analytics, using a fictitious grain production experiment as an illuminating
example.

## A synthetic dataset for a grain production experiment

To showcase how to use the **nert** package and the TERN SMIPS soil moisture
data to augment the analytics of an agronomics experiment, a simulated
dataset containing yield data for a fictitious grain production experiment has
been included with the **nert** package. The dataset is called `grain`, and 
you can load this dataset with:

```{r loaddata}
data(grain)
str(grain)
```

The `grain` dataset supposes that a fabricated grain production experiment has
been run at a selection of ten sites across South Australia, looking at the
effects of Nitrogen application and Seeding rate on the grain yield for some
crop with eight varieties. 

Note that we have locational coordinates (in `Latitude` and
`Longitude`) for each of the sites, as well as dates for the crop sowing and 
Nitrogen applications (in `SowDate` and `NitrogenDate` respectively.) This
spatiotemporal information is useful, as it allows us to match up the
experimental sites with the data points that we need to download from SMIPS.

## Download SMIPS data for the sites across times

(detail + code for that here, mostly as it appears in the files Max sent in
the emails. Add comments, and note that we are using the
percentage dataset (i.e., SMIndex) rather than the totalbucket (check with 
Max: is this the best way? Do things change too much for the worse if we
just use the default totalbucket?))

Work-in-progress:

For simplicity, suppose we are interested in the SMIPS soil moisture index 
(`SMindex`) data, for all days falling between the earliest Nitrogen 
application date up to 30 days after the last application date, and we want the
soil moisture index at each site (by latitude/longitude coordinates). We can
generate this date range in a straightforward way using the `NitrogenDate`
column of the `grain` dataset as follows:
```{r daterange}
start_date <- min(grain$NitrogenDate)
end_date <- max(grain$NitrogenDate) + 30
date_range <- seq(start_date, end_date, by = "1 day")

c(date_range[1], date_range[length(date_range)])
```

We also need the latitude and longitude for the sites, which we can readily 
retrieve from the `grain` dataset columns `Latitude` and `Longitude`:
```{r siteslist}
sites <- unique(grain[ , c("Site", "Latitude", "Longitude")])
sites
```

Now TERN supplies the SMIPS daily data rasters as cloud-optimised GeoTIFFs 
(or COGs), which contain the soil moisture point predictions across the
entirety of Australia. However, because they are cloud-optimised, we can be
clever in our downloading to make sure that we only download data for the
locations of interest, rather than the entire raster. The **nert** package works
in tandem with the **terra** package to achieve this efficiency:

- First, we download the _information_ for a daily SMIPS raster 
    using `nert::read_smips`,
- Then we _extract only the point values we need_, using `terra::extract`.

This leads to a quicker and tighter data download. The below code shows
this process. (Note that `terra::extract` is particular about the order
of the latitude/longitude coordinates: longitude should be specified first,
followed by latitude.)

```{r downloadsmipscache, include = FALSE}
smips_data <- readRDS("cache_smips_data.rds")
```

```{r downloadsmips, eval = FALSE}
smips_data <- data.frame()
for (i in 1:length(date_range)) {
  r <- read_smips(collection = "SMindex", day = date_range[i])
  smips_points <- terra::extract(
    x = r,
    y = data.frame(lon = sites$Longitude, lat = sites$Latitude),
    xy = TRUE
  )
  names(smips_points)[2] <- "smips_smi_perc"

  smips_data <- rbind(
    smips_data,
    data.frame(
      Date = date_range[i],
      Latitude = smips_points$y,
      Longitude = smips_points$x,
      smips_smi_perc = smips_points$smips_smi_perc
    )
  )
}
head(smips_data)
```

```{r downloadsmipsresults, echo = FALSE}
head(smips_data)
```

TODO: More here, plus forward reference to the modelling in the next bit.



## A simple model for grain yield

The first model, without SMIPS. Include Max's DAGs (as jpgs?) as figures. As
per the email Max sent. (assume that the Nitrogen is most active in the 30 
days after its application, for instance.)

## Augment the yield model with soil moisture data

The second model, including the SMIPS soil moisture as a confounder. As per
Max's email, we perhaps expect phenomenologically that soil moisture improves 
yield, but reduces the effect of Nitrogen in the soil due to volatilisation.
modeling shows that this is the case.
