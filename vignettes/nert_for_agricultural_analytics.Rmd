---
title: "Use nert to augment agricultural analytics with SMIPS data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Use nert to augment agricultural analytics with SMIPS data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

The TERN Soil Moisture Integration and Prediction System (SMIPS) generates
useful measurements of soil moisture at 1km resolution across all of Australia.
TERN provides this soil moisture information as packaged daily datasets [via
their TERN Data Portal](https://data.tern.org.au/model-derived/smips/), in
cloud-optimised GeoTIFF format. The **nert** package provides ease of access
to these SMIPS datasets for use and inclusion in R data analytics workflows.

This document introduces you to the **nert** package, including setup and
how to use the package to download SMIPS data for given locational coordinates
in Australia. The document then showcases an example of a grain production
experiment, and how we can use **nert** and the SMIPS soil moisture readings
to improve our analytics and modelling.

## Setup: Acquire and specify your TERN API key

An API key is required to access TERN datasets (including SMIPS) through 
their online data portal. The **nert** package streamlines the data process,
but still requires authorisation using an API key. However, it is
straightforward to sign up to the TERN Data Portal and acquire an API key that
you can use, and by setting it in your R environment (via `.Renviron`) you
can provide the **nert** package with that credential to allow convenient
access.

The following steps detail the process for signing up for a TERN account,
generating an API key, and storing it in your R environment:

 1. Navigate to the TERN Data Discovery Portal (https://portal.tern.org.au/) in 
a web browser


details and screenshots for this here. 

At end: include a quick example of how to
grab the data similar to what Adam had in the readme (e.g., just download
data for Adelaide CBD or something and show how it appears in the data frame).

```{r setup}
library(nert)

# ...
```


## A synthetic dataset for a grain production experiment

To showcase how to use the **nert** package and the TERN SMIPS soil moisture
data to augment the analytics of an agronomics experiment, a simulated
dataset containing yield data for a fictitious grain production experiment has
been included with the **nert** package. The dataset is called `grain`, and 
you can load this dataset with:

```{r loaddata}
data(grain)
str(grain)
```

The `grain` dataset supposes that a fabricated grain production experiment has
been run at a selection of ten sites across South Australia, looking at the
effects of Nitrogen application and Seeding rate on the grain yield for some
crop with eight varieties. 

Note that we have locational coordinates (in `Latitude` and
`Longitude`) for each of the sites, as well as dates for the crop sowing and 
Nitrogen applications (in `SowDate` and `NitrogenDate` respectively.) This
spatiotemporal information is useful, as it allows us to match up the
experimental sites with the data points that we need to download from SMIPS.

## Download SMIPS data for the sites across times

detail + code for that here, mostly as it appears in the files Max sent in
the emails. Add comments, and note that we are using the
percentage dataset (i.e., SMIndex) rather than the totalbucket (check with 
Max: is this the best way? Do things change too much for the worse if we
just use the default totalbucket?)

## A simple model for grain yield

The first model, without SMIPS. Include Max's DAGs (as jpgs?) as figures. As
per the email Max sent.

## Augment the yield model with soil moisture data

The second model, including the SMIPS soil moisture as a confounder. As per
Max's email, we perhaps expect phenomenologically that soil moisture improves 
yield, but reduces the effect of Nitrogen in the soil due to volatilisation.
modeling shows that this is the case.
