<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-AU">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using nert to augment agricultural analytics with SMIPS data • nert</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using nert to augment agricultural analytics with SMIPS data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nert</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/nert.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/nert_for_agricultural_analytics.html">Using nert to augment agricultural analytics with SMIPS data</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/AAGI-AUS/nert/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Using nert to augment agricultural analytics with SMIPS data</h1>
                        <h4 data-toc-skip class="author">Russell Edson
and Max Moldovan</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/AAGI-AUS/nert/blob/main/vignettes/nert_for_agricultural_analytics.Rmd" class="external-link"><code>vignettes/nert_for_agricultural_analytics.Rmd</code></a></small>
      <div class="d-none name"><code>nert_for_agricultural_analytics.Rmd</code></div>
    </div>

    
    
<!-- STOP! Do not edit this file. This file is generated from nert_for_agricultural_analytics.Rmd.orig -->
<p>The <strong>nert</strong> package provides straightforward and
seamless access to the TERN Soil Moisture Integration and Prediction
System (SMIPS) datasets, which include soil moisture estimates that can
be used in your data analytics pipelines. This document showcases this
process with the example of a synthesised multi-site grain production
experiment. The <strong>nert</strong> package is loaded and used to
download soil moisture time series data at various locations across
South Australia. Recognising soil moisture as a classical
confounder—affecting crop yield (via root-zone water availability) and
nitrogen treatment (via increased volatilisation in moist soils)—we will
augment our modelling of the grain production to use soil moisture
estimates over the treatment period for estimating the nitrogen
treatment effect.</p>
<div class="section level2">
<h2 id="a-synthetic-dataset-for-a-grain-production-experiment">A synthetic dataset for a grain production experiment<a class="anchor" aria-label="anchor" href="#a-synthetic-dataset-for-a-grain-production-experiment"></a>
</h2>
<p>A simulated dataset containing yield data for a fictitious grain
production experiment has been included with the <strong>nert</strong>
package. The dataset is called <code>grain</code>, and you can load the
package and this dataset with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://aagi-aus.github.io/nert/">nert</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">grain</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">grain</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    2880 obs. of  10 variables:</span></span>
<span><span class="co">#&gt;  $ Site             : Factor w/ 10 levels "Adelaide","Barossa Valley",..: 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ Latitude         : num  -34.9 -34.9 -34.9 -34.9 -34.9 ...</span></span>
<span><span class="co">#&gt;  $ Longitude        : num  139 139 139 139 139 ...</span></span>
<span><span class="co">#&gt;  $ SowDate          : Date, format: "2022-05-20" "2022-05-20" "2022-05-20" ...</span></span>
<span><span class="co">#&gt;  $ NitrogenDate     : Date, format: "2022-06-04" "2022-06-04" "2022-06-04" ...</span></span>
<span><span class="co">#&gt;  $ Rep              : Factor w/ 3 levels "1","2","3": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ Variety          : Factor w/ 8 levels "Variety_A","Variety_B",..: 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ Nitrogen_kgNha   : Factor w/ 4 levels "0","30","60",..: 1 1 1 2 2 2 3 3 3 4 ...</span></span>
<span><span class="co">#&gt;  $ SeedRate_plantsm2: Factor w/ 3 levels "75","150","300": 1 2 3 1 2 3 1 2 3 1 ...</span></span>
<span><span class="co">#&gt;  $ Yield_Tha        : num  3 3.69 3.89 2.76 3.27 ...</span></span></code></pre></div>
<p>The <code>grain</code> dataset supposes that a hypothetical grain
production experiment has been run at a selection of ten sites across
South Australia, investigating the effects of four different treatment
levels of nitrogen application and three different seeding rates on the
grain yield for some crop with eight varieties.</p>
<p>Note that we have locational coordinates (in <code>Latitude</code>
and <code>Longitude</code>) for each of the sites, as well as dates for
the crop sowing and nitrogen applications (in <code>SowDate</code> and
<code>NitrogenDate</code> respectively.) This spatio-temporal
information is useful, as it allows us to match up the experimental
sites with the data points that we need to download from SMIPS.</p>
</div>
<div class="section level2">
<h2 id="download-smips-data-for-the-sites-across-times">Download SMIPS data for the sites across times<a class="anchor" aria-label="anchor" href="#download-smips-data-for-the-sites-across-times"></a>
</h2>
<p>Here we use the <strong>nert</strong> package to download SMIPS soil
moisture datasets from the TERN Data Portal, which we can use to augment
our analysis of the <code>grain</code> experiment data. The two key
SMIPS datasets of interest are:</p>
<ol style="list-style-type: decimal">
<li><p><code>totalbucket</code>: an estimate of the <em>volumetric soil
moisture</em> (in units of mm) from the SMIPS bucket moisture
store,</p></li>
<li><p><code>SMindex</code>: the SMIPS <em>soil moisture index</em>
(i.e., a number between 0 and 1 that indicates how full the SMIPS bucket
moisture store is relative to its 90cm capacity).</p></li>
</ol>
<p>For simplicity, suppose we are interested in the SMIPS soil moisture
index (<code>SMindex</code>) data, for all days falling between the
earliest nitrogen application date up to 30 days after the last
application date, and we want the soil moisture index at each site (by
latitude/longitude coordinates). We can generate this date range in a
straightforward way using the <code>NitrogenDate</code> column of the
<code>grain</code> dataset as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">grain</span><span class="op">$</span><span class="va">NitrogenDate</span><span class="op">)</span></span>
<span><span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">grain</span><span class="op">$</span><span class="va">NitrogenDate</span><span class="op">)</span> <span class="op">+</span> <span class="fl">30</span></span>
<span><span class="va">date_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span>, by <span class="op">=</span> <span class="st">"1 day"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">date_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">date_range</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">date_range</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2022-05-07" "2022-07-15"</span></span></code></pre></div>
<p>We also need the latitude and longitude for the sites, which we can
readily retrieve from the <code>grain</code> dataset columns
<code>Latitude</code> and <code>Longitude</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sites</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">grain</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Site"</span>, <span class="st">"Latitude"</span>, <span class="st">"Longitude"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">sites</span></span>
<span><span class="co">#&gt;                    Site  Latitude Longitude</span></span>
<span><span class="co">#&gt; 1              Adelaide -34.94773  138.6244</span></span>
<span><span class="co">#&gt; 289      Barossa Valley -34.54843  138.9580</span></span>
<span><span class="co">#&gt; 577        Clare Valley -33.83754  138.6012</span></span>
<span><span class="co">#&gt; 865      Eyre Peninsula -34.37378  135.7967</span></span>
<span><span class="co">#&gt; 1153 Fleurieu Peninsula -35.52307  138.4608</span></span>
<span><span class="co">#&gt; 1441    Kangaroo Island -35.71041  137.0736</span></span>
<span><span class="co">#&gt; 1729    Limestone Coast -37.88957  140.6388</span></span>
<span><span class="co">#&gt; 2017         Sturt Vale -33.34666  140.0723</span></span>
<span><span class="co">#&gt; 2305        Murraylands -35.12425  139.3014</span></span>
<span><span class="co">#&gt; 2593    Yorke Peninsula -35.05124  137.2090</span></span></code></pre></div>
<p>Now TERN supplies the SMIPS daily data rasters as cloud-optimised
GeoTIFFs (or COGs), which contain the soil moisture point predictions
across the entirety of Australia. However, because they are
cloud-optimised, we can be clever in our downloading to make sure that
we only download data for the locations of interest, rather than the
entire raster. The <strong>nert</strong> package works in tandem with
the <strong>terra</strong> package to achieve this efficiency:</p>
<ul>
<li>First, we download the <em>information</em> for a daily SMIPS raster
using <code><a href="../reference/read_smips.html">nert::read_smips</a></code>,</li>
<li>Then we <em>extract only the point values we need</em>, using
<code><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">terra::extract</a></code>.</li>
</ul>
<p>This leads to a quicker and tighter data download. The below code
shows this process. (Note that <code><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">terra::extract</a></code> is particular
about the order of the latitude/longitude coordinates: longitude should
be specified first, followed by latitude.)</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smips_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">date_range</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_smips.html">read_smips</a></span><span class="op">(</span>collection <span class="op">=</span> <span class="st">"SMindex"</span>, day <span class="op">=</span> <span class="va">date_range</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">smips_points</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">r</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>lon <span class="op">=</span> <span class="va">sites</span><span class="op">$</span><span class="va">Longitude</span>, lat <span class="op">=</span> <span class="va">sites</span><span class="op">$</span><span class="va">Latitude</span><span class="op">)</span>,</span>
<span>    xy <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">smips_points</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"smips_smi_perc"</span></span>
<span></span>
<span>  <span class="va">smips_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="va">smips_data</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      Date <span class="op">=</span> <span class="va">date_range</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      Latitude <span class="op">=</span> <span class="va">smips_points</span><span class="op">$</span><span class="va">y</span>,</span>
<span>      Longitude <span class="op">=</span> <span class="va">smips_points</span><span class="op">$</span><span class="va">x</span>,</span>
<span>      smips_smi_perc <span class="op">=</span> <span class="va">smips_points</span><span class="op">$</span><span class="va">smips_smi_perc</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">smips_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Date  Latitude Longitude smips_smi_perc</span></span>
<span><span class="co">#&gt; 1 2022-05-07 -34.95253  138.6237     0.25906488</span></span>
<span><span class="co">#&gt; 2 2022-05-07 -34.55264  138.9537     0.17677850</span></span>
<span><span class="co">#&gt; 3 2022-05-07 -33.83285  138.6037     0.07674548</span></span>
<span><span class="co">#&gt; 4 2022-05-07 -34.37270  135.7944     0.53408158</span></span>
<span><span class="co">#&gt; 5 2022-05-07 -35.52237  138.4638     0.37496096</span></span>
<span><span class="co">#&gt; 6 2022-05-07 -35.71231  137.0741     0.30223876</span></span></code></pre></div>
<p>We can add the <code>Site</code> column to the
<code>smips_data</code> to make it easier to use it in conjunction with
the <code>grain</code> dataset during the analysis:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smips_data</span><span class="op">$</span><span class="va">Site</span> <span class="op">&lt;-</span> <span class="va">sites</span><span class="op">$</span><span class="va">Site</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">smips_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Date  Latitude Longitude smips_smi_perc               Site</span></span>
<span><span class="co">#&gt; 1 2022-05-07 -34.95253  138.6237     0.25906488           Adelaide</span></span>
<span><span class="co">#&gt; 2 2022-05-07 -34.55264  138.9537     0.17677850     Barossa Valley</span></span>
<span><span class="co">#&gt; 3 2022-05-07 -33.83285  138.6037     0.07674548       Clare Valley</span></span>
<span><span class="co">#&gt; 4 2022-05-07 -34.37270  135.7944     0.53408158     Eyre Peninsula</span></span>
<span><span class="co">#&gt; 5 2022-05-07 -35.52237  138.4638     0.37496096 Fleurieu Peninsula</span></span>
<span><span class="co">#&gt; 6 2022-05-07 -35.71231  137.0741     0.30223876    Kangaroo Island</span></span></code></pre></div>
<p>We are now ready to proceed with the analytics.</p>
</div>
<div class="section level2">
<h2 id="a-simple-model-for-grain-yield">A simple model for grain yield<a class="anchor" aria-label="anchor" href="#a-simple-model-for-grain-yield"></a>
</h2>
<p>First, we model the grain yield with a simple model without taking
into account any soil moisture confounding—that is, without reference to
the SMIPS data that we have just downloaded. We will later incorporate
the SMIPS data to see how including the soil moisture as a covariate
improves the nitrogen treatment effect size estimates.</p>
<p>Here we will use the <strong>nlme</strong> package to fit a linear
mixed-effect model. The grain yield <code>Yield_tha</code> will be
modelled taking the <code>Variety</code>, nitrogen application rate
<code>Nitrogen_kgNha</code> and seeding rate
<code>SeedRate_plantsm2</code> as fixed terms, and incorporating the
<code>Site</code> and replicate (<code>Rep</code>) structure of the
experiment in a random effect term.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://svn.r-project.org/R-packages/trunk/nlme/" class="external-link">nlme</a></span><span class="op">)</span></span>
<span><span class="va">simple_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link">lme</a></span><span class="op">(</span></span>
<span>  fixed <span class="op">=</span> <span class="va">Yield_Tha</span> <span class="op">~</span> <span class="va">Variety</span> <span class="op">*</span> <span class="va">Nitrogen_kgNha</span> <span class="op">*</span> <span class="va">SeedRate_plantsm2</span>,</span>
<span>  random <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">Site</span> <span class="op">/</span> <span class="va">Rep</span>,</span>
<span>  data <span class="op">=</span> <span class="va">grain</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can check the confidence intervals for the effect sizes of the
nitrogen treatments for this simple model:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simple_model.ints</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/intervals.html" class="external-link">intervals</a></span><span class="op">(</span><span class="va">simple_model</span>, which <span class="op">=</span> <span class="st">"fixed"</span><span class="op">)</span><span class="op">$</span><span class="va">fixed</span></span>
<span><span class="va">simple_model.Neffects</span> <span class="op">&lt;-</span> <span class="va">simple_model.ints</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Nitrogen_kgNha"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">60</span>, <span class="fl">90</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">simple_model.Neffects</span></span>
<span><span class="co">#&gt;                        lower      est.     upper</span></span>
<span><span class="co">#&gt; Nitrogen_kgNha30 -0.17355028 0.0392950 0.2521403</span></span>
<span><span class="co">#&gt; Nitrogen_kgNha60  0.08045472 0.2933000 0.5061453</span></span>
<span><span class="co">#&gt; Nitrogen_kgNha90  0.09779306 0.3106383 0.5234836</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="augmenting-the-yield-model-with-soil-moisture-data">Augmenting the yield model with soil moisture data<a class="anchor" aria-label="anchor" href="#augmenting-the-yield-model-with-soil-moisture-data"></a>
</h2>
<p>Next, we augment our modelling by including the SMIPS soil moisture
data as a covariate (perhaps anticipating that the soil moisture
improves the yield, but might reduce the effect of nitrogen applied to
the soil due to volatilisation). To keep things simple, for each site
(and its associated nitrogen application date) we take an average of the
SMIPS-reported soil moisture index from the date of the nitrogen
application until 30 days after the application, which we will store in
a new column called <code>SoilMoisture_avg</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">site</span> <span class="kw">in</span> <span class="va">sites</span><span class="op">$</span><span class="va">Site</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">grain</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">grain</span><span class="op">$</span><span class="va">Site</span> <span class="op">==</span> <span class="va">site</span><span class="op">)</span>, <span class="st">"NitrogenDate"</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">start_date</span> <span class="op">+</span> <span class="fl">30</span>, by <span class="op">=</span> <span class="st">"1 day"</span><span class="op">)</span></span>
<span>  <span class="va">smips</span> <span class="op">&lt;-</span> <span class="va">smips_data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">smips_data</span><span class="op">$</span><span class="va">Site</span> <span class="op">==</span> <span class="va">site</span> <span class="op">&amp;</span> <span class="va">smips_data</span><span class="op">$</span><span class="va">Date</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="va">dates</span><span class="op">)</span>, <span class="op">]</span></span>
<span>  <span class="va">smips_avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">smips</span><span class="op">[[</span><span class="st">"smips_smi_perc"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">grain</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">grain</span><span class="op">$</span><span class="va">Site</span> <span class="op">==</span> <span class="va">site</span><span class="op">)</span>, <span class="st">"SoilMoisture_avg"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">smips_avg</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can then add this average soil moisture as a fixed effect to the
linear mixed-effect model:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">augmented_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link">lme</a></span><span class="op">(</span></span>
<span>  fixed <span class="op">=</span> <span class="va">Yield_Tha</span> <span class="op">~</span> <span class="va">Variety</span> <span class="op">*</span> <span class="va">Nitrogen_kgNha</span> <span class="op">*</span> <span class="va">SeedRate_plantsm2</span></span>
<span>    <span class="op">+</span> <span class="va">SoilMoisture_avg</span> <span class="op">+</span> <span class="va">SoilMoisture_avg</span><span class="op">:</span><span class="va">Nitrogen_kgNha</span>,</span>
<span>  random <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">Site</span> <span class="op">/</span> <span class="va">Rep</span>,</span>
<span>  data <span class="op">=</span> <span class="va">grain</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The confidence intervals for the effect sizes of the nitrogen
application treatments for this augmented model are then as follows:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">augmented_model.ints</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/intervals.html" class="external-link">intervals</a></span><span class="op">(</span><span class="va">augmented_model</span>, which <span class="op">=</span> <span class="st">"fixed"</span><span class="op">)</span><span class="op">$</span><span class="va">fixed</span></span>
<span><span class="va">augmented_model.Neffects</span> <span class="op">&lt;-</span> <span class="va">augmented_model.ints</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Nitrogen_kgNha"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">60</span>, <span class="fl">90</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">augmented_model.Neffects</span></span>
<span><span class="co">#&gt;                        lower      est.     upper</span></span>
<span><span class="co">#&gt; Nitrogen_kgNha30 -0.03984861 0.2000454 0.4399395</span></span>
<span><span class="co">#&gt; Nitrogen_kgNha60  0.31409573 0.5539898 0.7938838</span></span>
<span><span class="co">#&gt; Nitrogen_kgNha90  0.33961765 0.5795117 0.8194058</span></span></code></pre></div>
<p>We can use <strong>ggplot2</strong> plotting to graph the confidence
intervals for the simple model versus the augmented model, and
illuminate the difference attained when we include the soil moisture as
a confounding term in our modelling:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">ci</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">simple_model.Neffects</span>, model <span class="op">=</span> <span class="st">"Simple Model"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">augmented_model.Neffects</span>, model <span class="op">=</span> <span class="st">"SMIPS-Augmented Model"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">ci</span><span class="op">$</span><span class="va">term</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Nitrogen_kgNha"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">60</span>, <span class="fl">90</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">ci</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">est.</span>, y <span class="op">=</span> <span class="va">term</span>, colour <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_y_discrete</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="va">rev</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="va">pd</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_errorbarh.html" class="external-link">geom_errorbarh</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">lower</span>, xmax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span>, position <span class="op">=</span> <span class="va">pd</span>, height <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"predictor"</span>, x <span class="op">=</span> <span class="st">"estimate"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="ploteffects-1.png" alt="Nitrogen effect estimates compared between the simple model and
  the SMIPS-augmented model." width="100%"><p class="caption">
Nitrogen effect estimates compared between the simple model and the
SMIPS-augmented model.
</p>
</div>
<p>From the comparison of the effect sizes for the nitrogen treatment,
we can see that ignoring the effect of soil moisture in the simple model
underestimates the direct nitrogen treatment effect. The augmented
model, in contrast, accounts for the soil moisture and the potential
nitrogen vaporisation that may occur in higher soil moisture
conditions.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Adam H. Sparks, Wasin Pipattungsakul, Russell Edson, Sam Rogers, Max Moldovan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
